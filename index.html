<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tiny Eater</title>
  
  <!-- PWA Configuration -->
  <meta name="theme-color" content="#84ADD8">
  <link rel="manifest" href="manifest.json">
  
  <!-- iOS specific meta tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Tiny Eater">
  <link rel="apple-touch-icon" href="icon-192.png">
  
  <!-- Additional PWA meta tags -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="Tiny Eater">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=KoHo:wght@200;300;400;500;600;700&display=swap" rel="stylesheet"> 
<link rel="apple-touch-icon" href="icon-192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
    extend: {
      fontFamily: {
        'koho': ['KoHo', 'sans-serif'],
      },
         colors: {
          'tiny-blue': '#84ADD8',
          'tiny-yellow': '#FDEE9F',
          'tiny-yellow-light': '#FBF5CC',
          'tiny-green': '#BDF5BC',
          'tiny-red': '#F5BCBF',
          'tiny-gray': '#D3D3D3',
          'tiny-pink': '#EB3E70',
          'tiny-pink-dark': '#CD456C',
      }
    }
  }
}
  </script>
  <style>
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
    .app-container { height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
    .content-area { flex: 1; overflow-y: auto; padding-bottom: 1rem; }
    .fixed-header { position: sticky; top: 0; z-index: 50; }
    .fixed-footer { position: sticky; bottom: 0; z-index: 50; }
    .hidden { display: none; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .tile-actions { opacity: 0; transition: opacity 0.2s; }
    .tile.active .tile-actions { opacity: 1; }
    .field-error { border-color: #FF2222 !important; border-width: 2px !important; }
    .error-message { color: #FF2222; font-size: 0.75rem; margin-top: 0.25rem; }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="app-container bg-white">
    <!-- Header with Profile Icon -->
    <div class="fixed-header bg-tiny-blue text-white py-4 relative border-b-4 border-tiny-yellow">
      <button onclick="showProfilePopup()" class="absolute left-4 top-1/2 transform -translate-y-1/2 p-2 rounded-full hover:bg-blue-400 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
        </svg>
      </button>
      <div class="text-center font-bold text-xl font-koho">TINY EATER</div>
    </div>

    <!-- Content -->
    <div class="content-area">
      <!-- Food Critic Tab -->
      <div id="critic-tab" class="tab-content active p-4">
        <!-- Controls -->
        <div class="flex justify-between items-center mb-6">
          <div class="bg-white rounded-full border-2 border-gray-200 flex overflow-hidden">
            <button onclick="setViewMode('tiles')" id="tiles-btn" class="px-8 py-2 text-sm font-normal transition-colors bg-tiny-yellow text-gray-800">
              Tiles
            </button>
            <button onclick="setViewMode('list')" id="list-btn" class="px-8 py-2 text-sm font-normal transition-colors text-gray-600 hover:bg-gray-50">
              List
            </button>
          </div>
          <button onclick="showAddForm()" class="bg-tiny-pink text-white px-4 py-2 rounded-full font-medium text-sm hover:bg-tiny-pink-dark transition-colors">
            + ADD A FOOD
          </button>
        </div>

        <!-- Sort Controls (for list view) -->
        <div id="sort-controls" class="flex gap-2 mb-4 hidden">
          <button onclick="setSortBy('date')" id="sort-date-btn" class="px-6 py-1 text-sm rounded-lg transition-colors bg-tiny-yellow text-gray-800">
            By Date
          </button>
          <button onclick="setSortBy('name')" id="sort-name-btn" class="px-6 py-1 text-sm rounded-lg transition-colors bg-gray-200 text-gray-600">
            By Name
          </button>
          <button onclick="setSortBy('rating')" id="sort-rating-btn" class="px-6 py-1 text-sm rounded-lg transition-colors bg-gray-200 text-gray-600">
            By Rating
          </button>
        </div>


        <!-- Food Entries Container -->
        <div id="foods-container">
          <div class="text-center py-12 text-gray-500">
            <div class="text-lg font-medium mb-2">No foods tracked yet.</div>
            <div>Add <span id="baby-name-display">baby's</span> first food to get started.</div>
          </div>
        </div>
      </div>

      <!-- Future Foodie Tab -->
      <div id="foodie-tab" class="tab-content p-6">
        <div class="text-center mb-6">
          <h2 class="text-xl font-bold text-gray-800 mb-0">First 100 Foods</h2>
          <p class="text-gray-600">to try before <span id="baby-name-display-2">baby</span> turns one.</p>
        </div>
        <div id="checklist-container"></div>
      </div>
    </div>

    <!-- Footer with Icons -->
    <div class="fixed-footer bg-tiny-blue text-white grid grid-cols-2">
  <button onclick="setTab('critic')" id="critic-tab-btn" class="py-3 px-4 text-center transition-colors bg-tiny-yellow text-gray-800">
    <svg class="w-5 h-5 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
    </svg>
    <span class="text-xs">Food Critic</span>
  </button>
  <button onclick="setTab('foodie')" id="foodie-tab-btn" class="py-3 px-4 text-center transition-colors hover:bg-blue-400">
    <svg class="w-5 h-5 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v6a2 2 0 002 2h2m9-9a2 2 0 012 2v6a2 2 0 01-2 2H9m9-9a2 2 0 00-2-2H7a2 2 0 00-2 2v6a2 2 0 002 2h10m0 0V7a2 2 0 00-2-2H7a2 2 0 00-2 2v6a2 2 0 002 2h10z"></path>
    </svg>
    <span class="text-xs">Future Foodie</span>
  </button>
</div>

  <!-- Profile Popup -->
  <div id="profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl p-6 w-full max-w-sm">
      <h2 class="text-xl font-bold text-gray-800 mb-6 text-center">Profile</h2>
      
      <div class="mb-4">
        <label class="block text-sm text-gray-700 mb-1">Name</label>
        <input type="text" id="profile-name" placeholder="Nicknames welcome" 
               class="w-full px-4 py-3 bg-tiny-yellow-light rounded-lg border-2 border-transparent focus:border-gray-300 focus:outline-none transition-colors placeholder-gray-500">
        <div id="profile-name-error" class="error-message hidden">Name is required</div>
      </div>
        
      <!-- Export/Import -->
        <div class="flex gap-2 mb-7">
          <button onclick="exportData()" class="flex items-center gap-2 px-3 py-2 border-2 border-gray-200 text-gray-700 rounded-full text-sm hover:bg-tiny-yellow-light transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
            Export Data
          </button>
          <label class="flex items-center gap-2 px-3 py-2 border-2 border-gray-200 text-gray-700 rounded-full text-sm hover:bg-tiny-yellow-light transition-colors cursor-pointer">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            Import Data
            <input type="file" accept=".json" onchange="importData(event)" class="hidden">
          </label>
        </div>
      
        <div class="flex gap-3">
        <button onclick="saveProfile()" class="flex-1 bg-tiny-pink text-white py-3 rounded-full font-medium hover:bg-tiny-pink-dark transition-colors">
          Save Name
        </button>
        <button onclick="closeProfilePopup()" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-full font-medium hover:bg-gray-400 transition-colors">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Food Form Modal -->
  <div id="food-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-3xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
      <h2 id="modal-title" class="text-xl font-bold text-gray-800 mb-6 text-center">New food adventure!</h2>
      
      <div class="mb-4">
        <label class="block text-sm text-gray-700 mb-1">Food name</label>
        <input type="text" id="food-name" placeholder="e.g. Banana" 
               class="w-full px-4 py-3 bg-tiny-yellow-light rounded-lg border-2 border-transparent focus:border-tiny-yellow focus:outline-none transition-colors placeholder-gray-500">
        <div id="food-name-error" class="error-message hidden">Food name is required</div>
      </div>

      <div class="mb-4">
        <label class="block text-sm text-gray-700 mb-1">Date First Tried</label>
        <input type="date" id="food-date" 
               class="w-full px-4 py-3 bg-tiny-yellow-light rounded-lg border-2 border-transparent focus:border-tiny-yellow focus:outline-none transition-colors text-gray-600">
        <div id="food-date-error" class="error-message hidden">Date is required</div>
      </div>

      <div class="mb-4">
        <label class="block text-sm text-gray-700 mb-1">Baby's Reaction</label>
        <div class="flex gap-3">
          <button type="button" onclick="setReaction('loved')" id="reaction-loved" 
        class="flex-1 px-3 py-3 rounded-full border-2 transition-all border-gray-200 hover:border-gray-300">
  <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
  </svg>
  <span class="text-sm text-gray-700">Loved</span>
</button>

<button type="button" onclick="setReaction('meh')" id="reaction-meh" 
        class="flex-1 px-3 py-3 rounded-full border-2 transition-all border-gray-200 hover:border-gray-300">
  <svg class="w-4 h-4 inline-block mr-1" fill="currentColor" viewBox="0 0 24 24">
    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
    <circle cx="9" cy="9" r="1"/>
    <circle cx="15" cy="9" r="1"/>
    <line x1="9" y1="15" x2="15" y2="15" stroke="currentColor" stroke-width="2"/>
  </svg>
  <span class="text-sm text-gray-700">Meh</span>
</button>

<button type="button" onclick="setReaction('hated')" id="reaction-hated" 
        class="flex-1 px-3 py-3 rounded-full border-2 transition-all border-gray-200 hover:border-gray-300">
  <svg class="w-4 h-4 inline-block mr-1" fill="currentColor" viewBox="0 0 24 24">
    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
    <circle cx="9" cy="9" r="1"/>
    <circle cx="15" cy="9" r="1"/>
    <path d="M16 16s-1.5-2-4-2-4 2-4 2" stroke="currentColor" stroke-width="2" fill="none"/>
  </svg>
  <span class="text-sm text-gray-700">Hated</span>
</button>
        </div>
      </div>

      <div class="mb-3">
        <label class="block text-sm text-gray-700 mb-1">Notes (Optional)</label>
        <textarea id="food-notes" placeholder="Any special observations or notes..." rows="3" 
                  class="w-full px-4 py-3 bg-tiny-yellow-light rounded-lg border-2 border-transparent focus:border-tiny-yellow focus:outline-none transition-colors resize-none placeholder-gray-500"></textarea>
      </div>

      <div class="mb-7">
        <label class="block text-sm text-gray-700 mb-1">Photo (Optional)</label>
        <label class="flex items-center gap-2 px-4 py-2 bg-tiny-yellow-light text-gray-700 rounded-full cursor-pointer hover:bg-yellow-200 transition-colors w-fit">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          Choose File
          <input type="file" id="food-photo" accept="image/*,video/*" onchange="handlePhotoUpload(event)" class="hidden">
        </label>
        <div id="photo-preview" class="mt-3 hidden"></div>
      </div>

      <div class="flex gap-3">
        <button onclick="saveFood()" id="save-food-btn" class="flex-1 bg-tiny-pink text-white py-3 rounded-full font-medium hover:bg-tiny-pink-dark transition-colors">
          Save Food
        </button>
        <button onclick="closeModal()" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-full font-medium hover:bg-gray-400 transition-colors">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

  <script>
    // Global app state
    let currentTab = 'critic';
    let viewMode = 'tiles';
    let sortBy = 'date';
    let foods = [];
    let profile = { name: '' };
    let checklist = {};
    let editingFood = null;
    let currentReaction = '';
    let currentMediaPreview = null;
    let isSaving = false;

    // 100 Foods Checklist Data
    const foodsChecklist = {
      "Fruits": [
        "Apple", "Avocado", "Banana", "Blueberries", "Cantaloupe", "Cherries", "Cranberries", 
        "Grapes", "Kiwi", "Mango", "Orange", "Papaya", "Peach", "Pear", "Pineapple", 
        "Plum", "Raspberries", "Strawberries", "Watermelon", "Apricot", "Blackberries", 
        "Coconut", "Dates", "Fig", "Grapefruit"
      ],
      "Vegetables": [
        "Artichoke", "Asparagus", "Beets", "Bell Pepper", "Broccoli", "Brussels Sprouts", 
        "Cabbage", "Carrots", "Cauliflower", "Celery", "Corn", "Cucumber", "Eggplant", 
        "Green Beans", "Kale", "Leeks", "Lettuce", "Mushrooms", "Onions", "Parsnips", 
        "Peas", "Potatoes", "Pumpkin", "Radish", "Spinach", "Sweet Potato", "Tomatoes", 
        "Turnips", "Zucchini", "Chard"
      ],
      "Grains & Cereals": [
        "Barley", "Brown Rice", "Buckwheat", "Millet", "Oats", "Pasta", "Quinoa", 
        "Rice", "Wheat", "Amaranth", "Bulgur", "Corn", "Farro", "Rye", "Wild Rice"
      ],
      "Proteins": [
        "Beef", "Chicken", "Turkey", "Salmon", "Tuna", "Cod", "Shrimp", "Eggs", 
        "Tofu", "Beans", "Lentils", "Chickpeas", "Nuts", "Seeds", "Yogurt"
      ],
      "Dairy": [
        "Cheese", "Cottage Cheese", "Cream Cheese", "Milk", "Yogurt", "Butter", 
        "Kefir", "Ricotta"
      ],
      "Herbs & Spices": [
        "Basil", "Cinnamon", "Garlic", "Ginger", "Oregano"
      ]
    };

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
      loadData();
      updatePersonalization();
      renderFoods();
      renderChecklist();
    });

    // Data persistence
    function loadData() {
  try {
    const savedFoods = localStorage.getItem('tinyEaterFoods');
    const savedProfile = localStorage.getItem('tinyEaterProfile');
    const savedChecklist = localStorage.getItem('tinyEaterChecklist');
    
    if (savedFoods && savedFoods !== 'undefined') {
      try {
        foods = JSON.parse(savedFoods);
      } catch (e) {
        console.error('Error parsing foods data:', e);
        foods = [];
      }
    }
    
    if (savedProfile && savedProfile !== 'undefined') {
      try {
        profile = JSON.parse(savedProfile);
        document.getElementById('profile-name').value = profile.name || '';
      } catch (e) {
        console.error('Error parsing profile data:', e);
        profile = { name: '' };
      }
    }
    
    if (savedChecklist && savedChecklist !== 'undefined') {
      try {
        checklist = JSON.parse(savedChecklist);
      } catch (e) {
        console.error('Error parsing checklist data:', e);
        checklist = {};
      }
    }
  } catch (error) {
    console.error('Error loading data:', error);
    // Initialize with empty data if loading fails
    foods = [];
    profile = { name: '' };
    checklist = {};
  }
}

    function saveData() {
  try {
    // Test if localStorage is available and working
    if (typeof(Storage) === "undefined") {
      throw new Error("LocalStorage not supported");
    }
    
    // Check available storage space
    const testData = JSON.stringify(foods);
    console.log('Trying to save foods data, size:', testData.length, 'characters');
    
    // Try to save with retry logic for mobile
    const foodsData = JSON.stringify(foods);
    const profileData = JSON.stringify(profile);
    const checklistData = JSON.stringify(checklist);
    
    // Clear old data first to make space
    localStorage.removeItem('tinyEaterFoods');
    localStorage.removeItem('tinyEaterProfile');
    localStorage.removeItem('tinyEaterChecklist');
    
    // Save new data
    localStorage.setItem('tinyEaterFoods', foodsData);
    localStorage.setItem('tinyEaterProfile', profileData);
    localStorage.setItem('tinyEaterChecklist', checklistData);
    
    // Test that the data was actually saved
    const testSave = localStorage.getItem('tinyEaterFoods');
    if (!testSave || testSave !== foodsData) {
      throw new Error("Data verification failed");
    }
    
    console.log('Data saved successfully');
    
  } catch (error) {
    console.error('LocalStorage error:', error);
    
    // Show user-friendly error
    if (error.message.includes('quota') || error.message.includes('storage') || error.name === 'QuotaExceededError') {
      alert('Storage space is full. Try deleting some old photos or foods to make space.');
    } else {
      alert('Error saving data: ' + error.message);
    }
    
    // Re-throw the error so saveFood can handle it
    throw error;
  }
}

function compressImage(file, maxWidth = 800, quality = 0.8) {
  return new Promise((resolve) => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    img.onload = () => {
      // Calculate new dimensions
      let { width, height } = img;
      
      if (width > maxWidth) {
        height = (height * maxWidth) / width;
        width = maxWidth;
      }
      
      canvas.width = width;
      canvas.height = height;
      
      // Draw and compress
      ctx.drawImage(img, 0, 0, width, height);
      const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
      resolve(compressedDataUrl);
    };
    
    img.src = URL.createObjectURL(file);
  });
}

    // Tab management
    function setTab(tab) {
      currentTab = tab;
      
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('[id$="-tab-btn"]').forEach(el => {
        el.className = el.className.replace('bg-tiny-yellow text-gray-800', 'hover:bg-blue-400');
      });
      
      document.getElementById(tab + '-tab').classList.add('active');
      document.getElementById(tab + '-tab-btn').className = 
        document.getElementById(tab + '-tab-btn').className.replace('hover:bg-blue-400', 'bg-tiny-yellow text-gray-800');
    }

    // View management
    function setViewMode(mode) {
      viewMode = mode;
      
      document.getElementById('tiles-btn').className = 
        mode === 'tiles' ? 'px-8 py-2 text-sm font-normal transition-colors bg-tiny-yellow text-gray-800' : 
        'px-8 py-2 text-sm font-normal transition-colors text-gray-600 hover:bg-gray-50';
      document.getElementById('list-btn').className = 
        mode === 'list' ? 'px-8 py-2 text-sm font-normal transition-colors bg-tiny-yellow text-gray-800' : 
        'px-8 py-2 text-sm font-normal transition-colors text-gray-600 hover:bg-gray-50';
      
      document.getElementById('sort-controls').classList.toggle('hidden', mode !== 'list');
      renderFoods();
    }

    function setSortBy(sort) {
      sortBy = sort;
      
      document.getElementById('sort-date-btn').className = 
        sort === 'date' ? 'px-3 py-1 text-sm rounded-full transition-colors bg-tiny-yellow text-gray-800' : 
        'px-3 py-1 text-sm rounded-full transition-colors bg-gray-200 text-gray-600';
      document.getElementById('sort-name-btn').className = 
        sort === 'name' ? 'px-3 py-1 text-sm rounded-full transition-colors bg-tiny-yellow text-gray-800' : 
        'px-3 py-1 text-sm rounded-full transition-colors bg-gray-200 text-gray-600';
      document.getElementById('sort-rating-btn').className = 
        sort === 'rating' ? 'px-3 py-1 text-sm rounded-full transition-colors bg-tiny-yellow text-gray-800' : 
        'px-3 py-1 text-sm rounded-full transition-colors bg-gray-200 text-gray-600';
      
      renderFoods();
    }

    // Food management
    function getSortedFoods() {
      return [...foods].sort((a, b) => {
        if (sortBy === 'name') {
          return a.name.localeCompare(b.name);
        } else if (sortBy === 'rating') {
          const ratingOrder = { 'loved': 3, 'meh': 2, 'hated': 1 };
          return (ratingOrder[b.reaction] || 0) - (ratingOrder[a.reaction] || 0);
        } else {
          return new Date(b.date) - new Date(a.date);
        }
      });
    }

    function renderFoods() {
      const container = document.getElementById('foods-container');
      
      if (foods.length === 0) {
        container.innerHTML = `
          <div class="text-center py-12 text-gray-500">
            <div class="text-lg font-medium mb-0">No foods tracked yet.</div>
            <div>Add <span id="baby-name-display">${profile.name || 'baby'}'s</span> first food to get started.</div>
          </div>
        `;
        return;
      }

      const sortedFoods = getSortedFoods();
      
      if (viewMode === 'list') {
        container.innerHTML = `
          <div class="space-y-3">
            ${sortedFoods.map(food => {
              const reaction = getReactionColor(food.reaction);
              return `
                <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100 flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="w-4 h-4 rounded-full ${reaction}"></div>
                    <div>
                      <div class="font-medium text-gray-800">${food.name}</div>
                      <div class="text-sm text-gray-500">${new Date(food.date).toLocaleDateString()}</div>
                    </div>
                  </div>
                  <div class="flex gap-2">
                    <button onclick="editFood(${food.id})" class="p-2 rounded-full hover:bg-gray-100 transition-all">
                      <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                      </svg>
                    </button>
                    <button onclick="deleteFood(${food.id})" class="p-2 rounded-full hover:bg-gray-100 transition-all">
                      <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                      </svg>
                    </button>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      } else {
        // Tiles view with click-to-show actions
        container.innerHTML = `
          <div class="space-y-4">
            ${sortedFoods.map(food => `
              <div class="tile bg-white rounded-2xl p-4 shadow-sm border border-gray-100 cursor-pointer" onclick="toggleTileActions(this)">
                ${food.mediaPreview ? `
                  <div class="mb-0 relative bg-gray-100 rounded-t-lg overflow-hidden h-95">
                    ${food.mediaType === 'image' ? 
                      `<img src="${food.mediaPreview}" alt="${food.name}" class="w-full h-95 object-contain">` :
                      `<video src="${food.mediaPreview}" class="w-full h-64 object-contain" controls></video>`
                    }
                    <div class="tile-actions absolute top-2 right-2 flex gap-2">
                      <button onclick="event.stopPropagation(); editFood(${food.id})" class="bg-white bg-opacity-80 p-2 rounded-full hover:bg-opacity-100 transition-all">
                        <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                      </button>
                      <button onclick="event.stopPropagation(); deleteFood(${food.id})" class="bg-white bg-opacity-80 p-2 rounded-full hover:bg-opacity-100 transition-all">
                        <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                      </button>
                    </div>
                  </div>
                ` : ''}
                
                <div class="relative">
                  ${!food.mediaPreview ? `
                    <div class="tile-actions absolute top-0 right-0 flex gap-2">
                      <button onclick="event.stopPropagation(); editFood(${food.id})" class="p-2 rounded-full hover:bg-gray-100 transition-all">
                        <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                      </button>
                      <button onclick="event.stopPropagation(); deleteFood(${food.id})" class="p-2 rounded-full hover:bg-gray-100 transition-all">
                        <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                      </button>
                    </div>
                  ` : ''}
                  ${getReactionDisplay(food.reaction)}
                  <h3 class="font-bold text-gray-800 mb-0">${food.name}</h3>
                  <div class="text-sm text-gray-600 mb-3">First tried: ${new Date(food.date).toLocaleDateString()}</div>
                  ${food.notes ? `<div class="mt-3 text-sm text-gray-600">${food.notes}</div>` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }
    }

    function toggleTileActions(tile) {
      document.querySelectorAll('.tile').forEach(t => t.classList.remove('active'));
      tile.classList.add('active');
    }

    function getReactionColor(reaction) {
      switch(reaction) {
        case 'loved': return 'bg-tiny-green';
        case 'meh': return 'bg-tiny-gray';
        case 'hated': return 'bg-tiny-red';
        default: return 'bg-gray-300';
      }
    }

    function getReactionDisplay(reaction) {
      const reactions = {
        'loved': { emoji: 'üòç', label: 'Loved', color: 'bg-tiny-green' },
        'meh': { emoji: 'üòê', label: 'Meh', color: 'bg-tiny-gray' },
        'hated': { emoji: 'üò†', label: 'Hated', color: 'bg-tiny-red' }
      };
      
      const r = reactions[reaction];
      if (!r) return '';
      
      return `
        <div class="flex items-center gap-2 px-3 py-1 rounded-b-lg ${r.color} text-gray-800 text-sm font-normal mb-3">
          ${r.emoji === 'üòç' ? 
  '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>' :
  r.emoji === 'üòê' ? 
  '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="9" cy="9" r="1"/><circle cx="15" cy="9" r="1"/><line x1="9" y1="15" x2="15" y2="15" stroke="currentColor" stroke-width="2"/></svg>' :
  '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="9" cy="9" r="1"/><circle cx="15" cy="9" r="1"/><path d="M16 16s-1.5-2-4-2-4 2-4 2" stroke="currentColor" stroke-width="2" fill="none"/></svg>'
}
          ${r.label}
        </div>
      `;
    }

    // Validation functions
    function clearValidationErrors() {
      document.querySelectorAll('.field-error').forEach(el => {
        el.classList.remove('field-error');
      });
      document.querySelectorAll('.error-message').forEach(el => {
        el.classList.add('hidden');
      });
    }

    function showFieldError(fieldId, errorId) {
      document.getElementById(fieldId).classList.add('field-error');
      document.getElementById(errorId).classList.remove('hidden');
    }

    // Profile management
    function showProfilePopup() {
      clearValidationErrors();
      document.getElementById('profile-modal').classList.remove('hidden');
    }

    function closeProfilePopup() {
      document.getElementById('profile-modal').classList.add('hidden');
    }

    function saveProfile() {
      clearValidationErrors();
      
      const name = document.getElementById('profile-name').value.trim();
      let hasErrors = false;
      
      if (!name) {
        showFieldError('profile-name', 'profile-name-error');
        hasErrors = true;
      }
      
      if (hasErrors) return;
      
      profile.name = name;
      saveData();
      updatePersonalization();
      closeProfilePopup();
    }

    function updatePersonalization() {
      const babyName = profile.name || 'baby';
      document.getElementById('baby-name-display').textContent = (profile.name || 'baby') + '\'s';
      document.getElementById('baby-name-display-2').textContent = profile.name || 'baby';
      renderFoods();
    }

    // Modal management
    function showAddForm() {
      editingFood = null;
      currentReaction = '';
      currentMediaPreview = null;
      
      clearValidationErrors();
      
      document.getElementById('modal-title').textContent = 'New food adventure!';
      document.getElementById('save-food-btn').textContent = 'Save Food';
      
      document.getElementById('food-name').value = '';
      document.getElementById('food-date').value = '';
      document.getElementById('food-notes').value = '';
      document.getElementById('food-photo').value = '';
      document.getElementById('photo-preview').innerHTML = '';
      document.getElementById('photo-preview').classList.add('hidden');
      
      document.querySelectorAll('[id^="reaction-"]').forEach(btn => {
        btn.className = 'flex-1 p-3 rounded-full border-2 transition-all text-center border-tiny-yellow hover:border-gray-300';
      });
      
      document.getElementById('food-modal').classList.remove('hidden');
    }

    function editFood(id) {
      const food = foods.find(f => f.id === id);
      if (!food) return;
      
      editingFood = food;
      currentReaction = food.reaction;
      currentMediaPreview = food.mediaPreview;
      
      clearValidationErrors();
      
      document.getElementById('modal-title').textContent = 'Edit food adventure!';
      document.getElementById('save-food-btn').textContent = 'Update Food';
      
      document.getElementById('food-name').value = food.name;
      document.getElementById('food-date').value = food.date;
      document.getElementById('food-notes').value = food.notes || '';
      
      setReaction(food.reaction);
      
      if (food.mediaPreview) {
        const preview = document.getElementById('photo-preview');
        preview.innerHTML = food.mediaType === 'image' ? 
          `<img src="${food.mediaPreview}" alt="Preview" class="w-32 h-32 object-contain rounded-lg">` :
          `<video src="${food.mediaPreview}" class="w-32 h-32 object-contain rounded-lg" controls></video>`;
        preview.classList.remove('hidden');
      }
      
      document.getElementById('food-modal').classList.remove('hidden');
    }

    function closeModal() {
  // Reset saving state when modal closes
  isSaving = false;
  
  // Reset button state
  const saveButton = document.getElementById('save-food-btn');
  saveButton.disabled = false;
  saveButton.textContent = editingFood ? 'Update Food' : 'Save Food';
  
  // Clear any reaction error
  const reactionError = document.getElementById('reaction-error');
  if (reactionError) {
    reactionError.remove();
  }
  
  document.getElementById('food-modal').classList.add('hidden');
}

    function handlePhotoUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  // Compress images before storing
  if (file.type.startsWith('image/')) {
    compressImage(file).then(compressedDataUrl => {
      currentMediaPreview = compressedDataUrl;
      const preview = document.getElementById('photo-preview');
      preview.innerHTML = `<img src="${compressedDataUrl}" alt="Preview" class="w-32 h-32 object-contain rounded-lg">`;
      preview.classList.remove('hidden');
    });
  } else {
    // Handle videos normally (they're usually smaller)
    const reader = new FileReader();
    reader.onload = function(e) {
      currentMediaPreview = e.target.result;
      const preview = document.getElementById('photo-preview');
      preview.innerHTML = `<video src="${e.target.result}" class="w-32 h-32 object-contain rounded-lg" controls></video>`;
      preview.classList.remove('hidden');
    };
    reader.readAsDataURL(file);
  }
}

    function saveFood() {
  // Prevent multiple saves
  if (isSaving) return;
  isSaving = true;
  
  // Disable the save button to prevent multiple clicks
  const saveButton = document.getElementById('save-food-btn');
  const originalText = saveButton.textContent;
  saveButton.disabled = true;
  saveButton.textContent = 'Saving...';
  
  clearValidationErrors();
  
  const name = document.getElementById('food-name').value.trim();
  const date = document.getElementById('food-date').value;
  const notes = document.getElementById('food-notes').value.trim();
  
  let hasErrors = false;
  
  if (!name) {
    showFieldError('food-name', 'food-name-error');
    hasErrors = true;
  }
  
  if (!date) {
    showFieldError('food-date', 'food-date-error');
    hasErrors = true;
  }
  
  if (!currentReaction) {
    // Add error display for missing reaction
    const reactionContainer = document.querySelector('[id^="reaction-"]').parentElement;
    if (reactionContainer) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message text-center mt-2';
      errorDiv.textContent = 'Please select a reaction';
      errorDiv.id = 'reaction-error';
      reactionContainer.appendChild(errorDiv);
    }
    hasErrors = true;
  }
  
  if (hasErrors) {
    // Re-enable button if there are errors
    saveButton.disabled = false;
    saveButton.textContent = originalText;
    isSaving = false;
    return;
  }
  
  try {
    const foodData = {
      name,
      date,
      reaction: currentReaction,
      notes,
      mediaPreview: currentMediaPreview,
      mediaType: currentMediaPreview ? (currentMediaPreview.startsWith('data:image/') ? 'image' : 'video') : null
    };
    
    if (editingFood) {
      const index = foods.findIndex(f => f.id === editingFood.id);
      if (index !== -1) {
        foods[index] = { ...foodData, id: editingFood.id, dateAdded: editingFood.dateAdded };
      }
    } else {
      foodData.id = Date.now() + Math.random(); // Ensure unique ID
      foodData.dateAdded = new Date().toISOString();
      foods.unshift(foodData);
    }
    
    // Save data with error handling
    try {
      saveData();
    } catch (error) {
      console.error('Error saving data:', error);
      alert('Error saving food. Please try again.');
      // Re-enable button on save error
      saveButton.disabled = false;
      saveButton.textContent = originalText;
      isSaving = false;
      return;
    }
    
    // Only render and close if save was successful
    renderFoods();
    closeModal();
    
  } catch (error) {
    console.error('Error in saveFood:', error);
    alert('An error occurred. Please try again.');
  } finally {
    // Always re-enable the button and reset saving state
    saveButton.disabled = false;
    saveButton.textContent = originalText;
    isSaving = false;
  }
}

function setReaction(reaction) {
  currentReaction = reaction;
  
  // Clear any existing reaction error
  const reactionError = document.getElementById('reaction-error');
  if (reactionError) {
    reactionError.remove();
  }
  
  document.querySelectorAll('[id^="reaction-"]').forEach(btn => {
    btn.className = 'flex-1 px-3 py-3 rounded-full border-2 transition-all border-gray-200 hover:border-gray-300';
  });
  
  const btn = document.getElementById(`reaction-${reaction}`);
  if (btn) {
    btn.className = 'flex-1 px-3 py-3 rounded-full border-2 transition-all bg-tiny-yellow-light border-tiny-yellow';
  }
}

    function deleteFood(id) {
      if (confirm('Are you sure you want to delete this food entry?')) {
        foods = foods.filter(f => f.id !== id);
        saveData();
        renderFoods();
      }
    }

    // Checklist management
    function renderChecklist() {
      const container = document.getElementById('checklist-container');
      
      container.innerHTML = Object.entries(foodsChecklist).map(([category, items]) => `
        <div class="bg-white rounded-2xl overflow-hidden shadow-sm border border-gray-100 mb-6">
          <div class="bg-tiny-green text-gray-800 px-4 py-3 font-bold">${category}</div>
          <div class="p-4 space-y-3">
            ${items.map(item => {
              const isChecked = checklist[`${category}-${item}`];
              return `
                <div class="flex items-center justify-between group">
                  <button onclick="toggleChecklistItem('${category}', '${item}')" class="flex items-center gap-3 flex-1 text-left">
                    <svg class="w-5 h-5 ${isChecked ? 'text-tiny-blue' : 'text-gray-400'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      ${isChecked ? 
                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>' :
                        '<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>'
                      }
                    </svg>
                    <span class="${isChecked ? 'line-through text-gray-500' : 'text-gray-700'}">${item}</span>
                  </button>
                  <button onclick="addFoodFromChecklist('${item}')" class="opacity-0 group-hover:opacity-100 bg-tiny-yellow text-gray-800 px-3 py-1 rounded-full text-sm font-light transition-opacity">
                    Add
                  </button>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `).join('');
    }

    function toggleChecklistItem(category, item) {
      const key = `${category}-${item}`;
      checklist[key] = !checklist[key];
      saveData();
      renderChecklist();
    }

    function addFoodFromChecklist(foodName) {
      setTab('critic');
      setTimeout(() => {
        showAddForm();
        document.getElementById('food-name').value = foodName;
        document.getElementById('food-date').value = new Date().toISOString().split('T')[0];
      }, 100);
    }

    // Data export/import
    function exportData() {
      const data = {
        foods,
        profile,
        checklist,
        exportDate: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `tiny-eater-backup-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          if (data.foods) foods = data.foods;
          if (data.profile) {
            profile = data.profile;
            document.getElementById('profile-name').value = profile.name || '';
          }
          if (data.checklist) checklist = data.checklist;
          
          saveData();
          updatePersonalization();
          renderFoods();
          renderChecklist();
          
          alert('Data imported successfully!');
        } catch (error) {
          alert('Error importing data. Please check the file format.');
        }
      };
      reader.readAsText(file);
    }
  </script>
</body>
</html>
